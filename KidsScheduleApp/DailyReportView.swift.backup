import SwiftUI

struct DailyReportView: View {
    @Environment(\.dismiss) private var dismiss
    let report: WorkDailyReport
    @State private var showingShareSheet = false
    
    var body: some View {
        NavigationView {
            ScrollView {
                VStack(alignment: .leading, spacing: 20) {
                    // æŠ¥å‘Šæ ‡é¢˜
                    reportHeader
                    
                    // ä»»åŠ¡ç»Ÿè®¡
                    taskStatistics

                    // åˆ†ç±»ç»Ÿè®¡
                    categoryBreakdownSection

                    // å·²å®Œæˆä»»åŠ¡
                    if !report.completedTasks.isEmpty {
                        completedTasksSection
                    }

                    // è¿›è¡Œä¸­ä»»åŠ¡
                    if !report.ongoingTasks.isEmpty {
                        ongoingTasksSection
                    }
                    
                    // æ—¶é—´åˆ†æ
                    timeAnalysisSection
                    
                    // å·¥ä½œæ€»ç»“
                    workSummarySection
                }
                .padding()
            }
            .navigationTitle("æ¯æ—¥æ´»åŠ¨æŠ¥å‘Š")
            .navigationBarTitleDisplayMode(.inline)
            .toolbar {
                ToolbarItem(placement: .navigationBarLeading) {
                    Button("å…³é—­") {
                        dismiss()
                    }
                }
                
                ToolbarItem(placement: .navigationBarTrailing) {
                    Button("åˆ†äº«") {
                        showingShareSheet = true
                    }
                    .fontWeight(.semibold)
                }
            }
            .sheet(isPresented: $showingShareSheet) {
                ShareSheet(activityItems: [generateReportText()])
            }
        }
    }
    
    // MARK: - æŠ¥å‘Šæ ‡é¢˜
    private var reportHeader: some View {
        VStack(alignment: .leading, spacing: 8) {
            HStack {
                Image(systemName: "chart.bar.doc.horizontal.fill")
                    .font(.title2)
                    .foregroundColor(.blue)
                Text(report.formattedDate)
                    .font(.title2)
                    .fontWeight(.bold)
                Spacer()
            }
            
            Text("æ—¥å¸¸æ´»åŠ¨æ±‡æŠ¥")
                .font(.subheadline)
                .foregroundColor(.secondary)
        }
        .padding()
        .background(Color.blue.opacity(0.1))
        .cornerRadius(12)
    }
    
    // MARK: - ä»»åŠ¡ç»Ÿè®¡
    private var taskStatistics: some View {
        VStack(alignment: .leading, spacing: 12) {
            Text("ğŸ“Š ä»»åŠ¡ç»Ÿè®¡")
                .font(.headline)
                .fontWeight(.semibold)

            LazyVGrid(columns: Array(repeating: GridItem(.flexible()), count: 2), spacing: 12) {
                StatisticCard(
                    title: "æ€»ä»»åŠ¡æ•°",
                    value: "\(report.allTasks.count)",
                    subtitle: "é¡¹ä»»åŠ¡",
                    color: .blue,
                    icon: "list.bullet"
                )

                StatisticCard(
                    title: "å·²å®Œæˆ",
                    value: "\(report.completedTasks.count)",
                    subtitle: "é¡¹ä»»åŠ¡",
                    color: .green,
                    icon: "checkmark.circle.fill"
                )

                StatisticCard(
                    title: "å®Œæˆç‡",
                    value: "\(String(format: "%.1f", report.completionRate))",
                    subtitle: "%",
                    color: report.completionRate >= 80 ? .green : (report.completionRate >= 60 ? .orange : .red),
                    icon: "percent"
                )

                StatisticCard(
                    title: "æ—¶é—´æŠ•å…¥",
                    value: "\(String(format: "%.1f", report.totalTimeSpent))",
                    subtitle: "å°æ—¶",
                    color: .purple,
                    icon: "clock.fill"
                )
            }
        }
        .padding()
        .background(Color(.systemBackground))
        .cornerRadius(12)
        .shadow(color: .black.opacity(0.1), radius: 4, x: 0, y: 2)
    }

    // MARK: - åˆ†ç±»ç»Ÿè®¡
    private var categoryBreakdownSection: some View {
        VStack(alignment: .leading, spacing: 12) {
            Text("ğŸ“‹ åˆ†ç±»ç»Ÿè®¡")
                .font(.headline)
                .fontWeight(.semibold)

            categoryStatsContent
        }
        .padding()
        .background(Color(.systemBackground))
        .cornerRadius(12)
        .shadow(color: .black.opacity(0.1), radius: 4, x: 0, y: 2)
    }

    private var categoryStatsContent: some View {
        Group {
            if report.tasksByCategory.isEmpty {
                Text("ä»Šæ—¥æš‚æ— ä»»åŠ¡")
                    .foregroundColor(.secondary)
                    .frame(maxWidth: .infinity, alignment: .center)
                    .padding()
            } else {
                categoryStatsList
            }
        }
    }

    private var categoryStatsList: some View {
        ForEach(Array(report.tasksByCategory.keys.sorted()), id: \.self) { category in
            categoryStatCard(for: category)
        }
    }

    private func categoryStatCard(for category: String) -> some View {
        let tasks = report.tasksByCategory[category] ?? []
        let completed = tasks.filter { $0.isCompleted }.count
        let completionRate = tasks.isEmpty ? 0 : Double(completed) / Double(tasks.count) * 100

        return CategoryStatCard(
            category: category,
            totalTasks: tasks.count,
            completedTasks: completed,
            completionRate: completionRate,
            icon: categoryIcon(for: category)
        )
    }

    // MARK: - å·²å®Œæˆä»»åŠ¡
    private var completedTasksSection: some View {
        VStack(alignment: .leading, spacing: 12) {
            Text("âœ… å·²å®Œæˆä»»åŠ¡ (\(report.completedTasks.count)é¡¹)")
                .font(.headline)
                .fontWeight(.semibold)
                .foregroundColor(.green)
            
            ForEach(report.completedTasks, id: \.objectID) { task in
                TaskReportCard(task: task, isCompleted: true)
            }
        }
        .padding()
        .background(Color.green.opacity(0.05))
        .cornerRadius(12)
        .overlay(
            RoundedRectangle(cornerRadius: 12)
                .stroke(Color.green.opacity(0.2), lineWidth: 1)
        )
    }
    
    // MARK: - è¿›è¡Œä¸­ä»»åŠ¡
    private var ongoingTasksSection: some View {
        VStack(alignment: .leading, spacing: 12) {
            Text("ğŸ”„ è¿›è¡Œä¸­ä»»åŠ¡ (\(report.ongoingTasks.count)é¡¹)")
                .font(.headline)
                .fontWeight(.semibold)
                .foregroundColor(.orange)
            
            ForEach(report.ongoingTasks, id: \.objectID) { task in
                TaskReportCard(task: task, isCompleted: false)
            }
        }
        .padding()
        .background(Color.orange.opacity(0.05))
        .cornerRadius(12)
        .overlay(
            RoundedRectangle(cornerRadius: 12)
                .stroke(Color.orange.opacity(0.2), lineWidth: 1)
        )
    }
    
    // MARK: - æ—¶é—´åˆ†æ
    private var timeAnalysisSection: some View {
        VStack(alignment: .leading, spacing: 12) {
            Text("â±ï¸ æ—¶é—´åˆ†æ")
                .font(.headline)
                .fontWeight(.semibold)
            
            VStack(spacing: 8) {
                HStack {
                    Text("æ€»å·¥ä½œæ—¶é•¿")
                    Spacer()
                    Text("\(String(format: "%.1f", report.totalTimeSpent))å°æ—¶")
                        .fontWeight(.medium)
                }
                
                if !report.allTasks.isEmpty {
                    HStack {
                        Text("å¹³å‡æ¯é¡¹ä»»åŠ¡")
                        Spacer()
                        Text("\(String(format: "%.1f", report.totalTimeSpent / Double(report.allTasks.count)))å°æ—¶")
                            .fontWeight(.medium)
                    }
                }
                
                HStack {
                    Text("å·¥ä½œæ•ˆç‡")
                    Spacer()
                    Text(getEfficiencyText())
                        .fontWeight(.medium)
                        .foregroundColor(getEfficiencyColor())
                }
            }
        }
        .padding()
        .background(Color(.systemBackground))
        .cornerRadius(12)
        .shadow(color: .black.opacity(0.1), radius: 4, x: 0, y: 2)
    }
    
    // MARK: - å·¥ä½œæ€»ç»“
    private var workSummarySection: some View {
        VStack(alignment: .leading, spacing: 12) {
            Text("ğŸ“ å·¥ä½œæ€»ç»“")
                .font(.headline)
                .fontWeight(.semibold)
            
            VStack(alignment: .leading, spacing: 8) {
                if report.completedTasks.count > 0 {
                    Text("âœ… ä»Šæ—¥æˆåŠŸå®Œæˆ \(report.completedTasks.count) é¡¹å·¥ä½œä»»åŠ¡")
                        .foregroundColor(.green)
                }
                
                if report.ongoingTasks.count > 0 {
                    Text("ğŸ”„ è¿˜æœ‰ \(report.ongoingTasks.count) é¡¹å·¥ä½œæ­£åœ¨è¿›è¡Œä¸­")
                        .foregroundColor(.orange)
                }
                
                if report.totalTimeSpent > 0 {
                    Text("â±ï¸ æ€»è®¡æŠ•å…¥ \(String(format: "%.1f", report.totalTimeSpent)) å°æ—¶å·¥ä½œæ—¶é—´")
                        .foregroundColor(.blue)
                }
                
                if report.progressUpdates > 0 {
                    Text("ğŸ“ˆ æ›´æ–°äº† \(report.progressUpdates) é¡¹å·¥ä½œè¿›åº¦")
                        .foregroundColor(.purple)
                }
            }
            .font(.subheadline)
        }
        .padding()
        .background(Color(.systemBackground))
        .cornerRadius(12)
        .shadow(color: .black.opacity(0.1), radius: 4, x: 0, y: 2)
    }
    
    // MARK: - è¾…åŠ©æ–¹æ³•
    private func getEfficiencyText() -> String {
        let completionRate = report.completionRate
        if completionRate >= 90 {
            return "ä¼˜ç§€"
        } else if completionRate >= 70 {
            return "è‰¯å¥½"
        } else if completionRate >= 50 {
            return "ä¸€èˆ¬"
        } else {
            return "éœ€æ”¹è¿›"
        }
    }
    
    private func getEfficiencyColor() -> Color {
        let completionRate = report.completionRate
        if completionRate >= 90 {
            return .green
        } else if completionRate >= 70 {
            return .blue
        } else if completionRate >= 50 {
            return .orange
        } else {
            return .red
        }
    }
    
    private func generateReportText() -> String {
        var text = """
        ğŸ“Š \(report.formattedDate) å·¥ä½œæ—¥æŠ¥
        
        ğŸ“ˆ æ´»åŠ¨ç»Ÿè®¡ï¼š
        â€¢ æ¶‰åŠä»»åŠ¡ï¼š\(report.allTasks.count)é¡¹
        â€¢ å·²å®Œæˆï¼š\(report.completedTasks.count)é¡¹
        â€¢ å®Œæˆç‡ï¼š\(String(format: "%.1f", report.completionRate))%
        â€¢ æ—¶é—´æŠ•å…¥ï¼š\(String(format: "%.1f", report.totalTimeSpent))å°æ—¶
        
        """
        
        if !report.completedTasks.isEmpty {
            text += "âœ… å·²å®Œæˆå·¥ä½œï¼š\n"
            for task in report.completedTasks {
                text += "â€¢ \(task.title ?? "æœªçŸ¥ä»»åŠ¡")\n"
            }
            text += "\n"
        }
        
        if !report.ongoingTasks.isEmpty {
            text += "ğŸ”„ è¿›è¡Œä¸­å·¥ä½œï¼š\n"
            for task in report.ongoingTasks {
                text += "â€¢ \(task.title ?? "æœªçŸ¥ä»»åŠ¡") (\(task.progressPercentage)%)\n"
            }
        }
        
        return text
    }

// MARK: - ç»Ÿè®¡å¡ç‰‡
struct StatisticCard: View {
    let title: String
    let value: String
    let subtitle: String
    let color: Color
    let icon: String
    
    var body: some View {
        VStack(spacing: 8) {
            Image(systemName: icon)
                .font(.title2)
                .foregroundColor(color)
            
            HStack(alignment: .bottom, spacing: 2) {
                Text(value)
                    .font(.title2)
                    .fontWeight(.bold)
                    .foregroundColor(color)
                Text(subtitle)
                    .font(.caption)
                    .foregroundColor(.secondary)
            }
            
            Text(title)
                .font(.caption)
                .foregroundColor(.secondary)
                .multilineTextAlignment(.center)
        }
        .frame(maxWidth: .infinity)
        .padding()
        .background(color.opacity(0.1))
        .cornerRadius(12)
    }
}

// MARK: - ä»»åŠ¡æŠ¥å‘Šå¡ç‰‡
struct TaskReportCard: View {
    let task: TaskItem
    let isCompleted: Bool
    
    var body: some View {
        HStack(spacing: 12) {
            Image(systemName: isCompleted ? "checkmark.circle.fill" : "circle.dashed")
                .foregroundColor(isCompleted ? .green : .orange)
                .font(.title3)
            
            VStack(alignment: .leading, spacing: 4) {
                Text(task.title ?? "æœªçŸ¥ä»»åŠ¡")
                    .font(.subheadline)
                    .fontWeight(.medium)
                
                HStack {
                    if !isCompleted {
                        Text("è¿›åº¦: \(task.progressPercentage)%")
                            .font(.caption)
                            .foregroundColor(.secondary)
                    }
                    
                    if task.timeSpent > 0 {
                        Text("â±ï¸ \(task.formattedTimeSpent)")
                            .font(.caption)
                            .foregroundColor(.secondary)
                    }
                }
            }
            
            Spacer()
        }
        .padding(.vertical, 8)
    }

    // MARK: - è¾…åŠ©æ–¹æ³•
    private func categoryIcon(for category: String) -> String {
        switch category {
        case "å·¥ä½œ":
            return "ğŸ’¼"
        case "å­¦ä¹ ":
            return "ğŸ“š"
        case "è¿åŠ¨":
            return "ğŸƒ"
        case "å¨±ä¹":
            return "ğŸ®"
        case "ç”Ÿæ´»":
            return "ğŸ "
        case "å…¶ä»–":
            return "ğŸ“"
        default:
            return "ğŸ“‹"
        }
    }
}

// MARK: - åˆ†ç±»ç»Ÿè®¡å¡ç‰‡
struct CategoryStatCard: View {
    let category: String
    let totalTasks: Int
    let completedTasks: Int
    let completionRate: Double
    let icon: String

    var body: some View {
        HStack {
            Text(icon)
                .font(.title2)

            VStack(alignment: .leading, spacing: 4) {
                Text(category)
                    .font(.subheadline)
                    .fontWeight(.medium)

                Text("\(completedTasks)/\(totalTasks) å®Œæˆ")
                    .font(.caption)
                    .foregroundColor(.secondary)
            }

            Spacer()

            VStack(alignment: .trailing, spacing: 4) {
                Text("\(String(format: "%.0f", completionRate))%")
                    .font(.subheadline)
                    .fontWeight(.semibold)
                    .foregroundColor(completionRate >= 80 ? .green : (completionRate >= 60 ? .orange : .red))

                ProgressView(value: completionRate, total: 100)
                    .progressViewStyle(LinearProgressViewStyle(tint: completionRate >= 80 ? .green : (completionRate >= 60 ? .orange : .red)))
                    .frame(width: 60)
            }
        }
        .padding(.horizontal, 12)
        .padding(.vertical, 8)
        .background(Color(.systemGray6))
        .cornerRadius(8)
    }
}

// MARK: - åˆ†äº«åŠŸèƒ½
struct ShareSheet: UIViewControllerRepresentable {
    let activityItems: [Any]
    
    func makeUIViewController(context: Context) -> UIActivityViewController {
        UIActivityViewController(activityItems: activityItems, applicationActivities: nil)
    }
    
    func updateUIViewController(_ uiViewController: UIActivityViewController, context: Context) {}
}

#Preview {
    let context = PersistenceController.preview.container.viewContext
    
    let task1 = TaskItem(context: context)
    task1.title = "å®Œæˆé¡¹ç›®æŠ¥å‘Š"
    task1.category = "å·¥ä½œ"
    task1.isCompleted = true
    task1.timeSpent = 4.5
    task1.workProgress = 100

    let task2 = TaskItem(context: context)
    task2.title = "å®¢æˆ·éœ€æ±‚åˆ†æ"
    task2.category = "å·¥ä½œ"
    task2.isCompleted = false
    task2.timeSpent = 2.0
    task2.workProgress = 65

    let task3 = TaskItem(context: context)
    task3.title = "é˜…è¯»æŠ€æœ¯æ–‡æ¡£"
    task3.category = "å­¦ä¹ "
    task3.isCompleted = true
    task3.timeSpent = 1.5
    task3.workProgress = 100

    let allTasks = [task1, task2, task3]
    let tasksByCategory = Dictionary(grouping: allTasks) { $0.category ?? "å…¶ä»–" }

    let report = WorkDailyReport(
        date: Date(),
        allTasks: allTasks,
        tasksByCategory: tasksByCategory,
        totalTimeSpent: 8.0,
        completedTasks: [task1, task3],
        ongoingTasks: [task2],
        progressUpdates: 3
    )
    
    return DailyReportView(report: report)
}
